#!/bin/bash

LOCATION="$HOME/WezTerm.AppImage"
REPONAME="wez/wezterm"
ASSETENDING="Ubuntu18.04.AppImage"
echo "Querying the GitHub API for the latest release (of $REPONAME)..."
RELEASENAME=`curl --silent "https://api.github.com/repos/$REPONAME/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/'`
echo $RELEASENAME > "$LOCATION.release.new"
if cmp --silent "$LOCATION.release" "$LOCATION.release.new"; then
	echo "Latest version is already installed."
	rm "$LOCATION.release.new"
else
	rm $LOCATION && echo "Removed WezTerm at $LOCATION. Reinstalling..." || echo "WezTerm not found at $LOCATION. Installing it (hopefully) for the first time..."
	INSTALLNAME="WezTerm-$RELEASENAME-$ASSETENDING"
	echo "Got $RELEASENAME, downloading $INSTALLNAME..."
	curl -LO "https://github.com/$REPONAME/releases/download/$RELEASENAME/$INSTALLNAME"
	echo $RELEASENAME > "$LOCATION.release"
	echo "Downloaded $INSTALLNAME."
	echo "Cleaning up..."
	mv $INSTALLNAME $LOCATION
	chmod +x $LOCATION
	rm "$LOCATION.release.new"
	echo "Installed $INSTALLNAME (from $REPONAME), as $LOCATION."
fi
echo "All done."

